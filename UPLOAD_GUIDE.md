# 高级上传功能使用指南

## 📖 概述

Flask NAS 文件浏览器提供了三种智能上传方式，针对不同的文件大小和网络环境自动选择最佳上传策略。

---

## 🎯 三种上传方式对比

| 上传方式 | 适用场景 | 文件大小 | 网络要求 | 特点 |
|---------|---------|---------|---------|------|
| **直接上传** | 小文件、稳定网络 | < 100MB | 稳定 | ⚡ 速度最快，一次性完成 |
| **分片上传** | 大文件 | > 100MB | 一般 | 🧩 分块上传，降低单次压力 |
| **断点续传** | 超大文件、不稳定网络 | > 500MB 或任意 | 不稳定 | 🔄 可中断恢复，最可靠 |

---

## 🚀 使用流程

### 步骤1：选择文件

点击"选择文件"按钮，选择要上传的一个或多个文件。

### 步骤2：智能判断

- **文件 < 10MB**：系统自动使用"直接上传"
- **文件 ≥ 10MB**：弹出选择框，由您选择上传方式

### 步骤3：选择上传方式

如果文件 ≥ 10MB，会出现以下选项：

#### 🚀 直接上传（快速）

**适用场景**：
- 网络连接稳定
- 文件大小 < 100MB
- 希望快速完成上传

**特点**：
- ✅ 速度最快
- ✅ 实时进度显示
- ❌ 不支持断点续传
- ❌ 网络中断需重新上传

**推荐**：日常文件、办公文档、小视频

---

#### 🧩 分片上传（稳定）

**适用场景**：
- 文件较大（100MB - 1GB）
- 网络一般稳定
- 希望降低服务器压力

**工作原理**：
1. 文件被分成多个 2MB 的小块
2. 每个分片独立上传
3. 所有分片上传完成后自动合并

**特点**：
- ✅ 降低单次上传压力
- ✅ 显示分片进度（如：分片 5/10）
- ✅ 服务器内存占用小
- ⚠️ 需要完整上传所有分片

**推荐**：大型文档、高清视频、数据备份

**进度显示**：
```
正在上传... 50% (分片 5/10)
```

---

#### 🔄 断点续传（可恢复）

**适用场景**：
- 超大文件（> 1GB）
- 网络不稳定（WiFi、移动网络）
- 需要长时间上传
- 可能中途暂停

**工作原理**：
1. 计算文件的唯一哈希值（MD5）
2. 上传前检查是否有未完成的上传
3. 从上次中断的位置继续上传
4. 所有分片完成后合并

**特点**：
- ✅ 网络中断可恢复
- ✅ 支持暂停和继续
- ✅ 基于文件内容识别，重命名也能续传
- ✅ 最可靠的上传方式
- ⚠️ 需要计算文件哈希（耗时）

**推荐**：超大视频、系统镜像、数据库备份

**进度显示**：
```
正在计算文件哈希... (1/1)
检测到断点，从 15/20 继续...
正在上传... 80% (分片 16/20)
```

---

## 💡 使用技巧

### 1. 断点续传的正确使用

**场景1：网络中断后恢复**
```
第一次上传：
- 文件：大型视频.mp4（2GB）
- 进度：30% (分片 6/20)
- 状态：网络中断 ❌

第二次上传：
- 选择同一文件
- 选择"断点续传"
- 系统自动检测：✅ 发现之前上传了 6 个分片
- 从第 7 个分片继续
```

**场景2：主动暂停**
```
1. 正在上传大文件
2. 需要临时使用网络做其他事情
3. 关闭浏览器或刷新页面
4. 稍后重新选择文件
5. 选择"断点续传"
6. 自动从断点继续 ✅
```

### 2. 如何选择上传方式？

**决策树**：
```
文件大小？
├─ < 10MB → 自动直接上传 ✅
├─ 10MB - 100MB
│   ├─ 网络稳定 → 直接上传
│   └─ 网络一般 → 分片上传
├─ 100MB - 1GB
│   ├─ 网络稳定 → 分片上传
│   └─ 网络不稳定 → 断点续传
└─ > 1GB → 断点续传（推荐）
```

### 3. 批量上传注意事项

- ✅ 支持同时选择多个文件
- ✅ 每个文件独立上传
- ⚠️ 如果有大文件，建议分批上传
- ⚠️ 断点续传时，每个文件独立计算哈希

---

## 🔍 技术细节

### 分片大小

默认分片大小：**2MB**

**为什么是 2MB？**
- ✅ 网络传输稳定性好
- ✅ 内存占用合理
- ✅ 重传成本低
- ✅ 适应大部分网络环境

### 文件哈希计算

**算法**：MD5（使用 SparkMD5 库）

**计算方式**：
- 不是一次性读取整个文件
- 分块读取（2MB/块）
- 增量计算哈希
- 内存友好，支持超大文件

**哈希用途**：
- 唯一标识文件
- 断点续传的关键
- 即使文件重命名也能识别

### 临时文件管理

**存储位置**：`系统临时目录/flask_nas_uploads/`

**目录结构**：
```
flask_nas_uploads/
└── a1b2c3d4e5f6...（文件哈希）/
    ├── chunk_0
    ├── chunk_1
    ├── chunk_2
    ├── ...
    └── meta.json（元数据）
```

**meta.json 内容**：
```json
{
  "filename": "大型视频.mp4",
  "total_chunks": 20,
  "uploaded_chunks": [0, 1, 2, 3, 4, 5],
  "target_path": "/mnt/nas/videos"
}
```

**清理机制**：
- ✅ 上传完成后自动删除临时文件
- ⚠️ 中断的上传会保留，用于断点续传
- 💡 建议定期清理临时目录（手动或定时任务）

---

## ❓ 常见问题

### Q1：断点续传失败，提示"文件哈希不匹配"？

**原因**：文件内容被修改了

**解决**：
- 确保上传的是同一个文件
- 文件内容不能修改
- 重命名可以，但内容不能变

### Q2：分片上传比直接上传慢？

**正常现象**：
- 分片上传需要多次HTTP请求
- 每个分片有独立的握手过程
- 但更稳定，不容易失败

**建议**：
- 小文件（< 100MB）用直接上传
- 大文件才用分片/断点续传

### Q3：如何清理未完成的上传？

**手动清理**：
```bash
# 临时文件目录（根据操作系统不同）
# Windows: C:\Users\<用户>\AppData\Local\Temp\flask_nas_uploads\
# Linux: /tmp/flask_nas_uploads/

# 删除所有临时文件
rm -rf /tmp/flask_nas_uploads/*
```

**建议**：保留最近1周的临时文件，定期清理旧文件

### Q4：支持多个文件同时断点续传吗？

**支持**：
- ✅ 每个文件独立管理
- ✅ 每个文件独立计算哈希
- ✅ 可以同时恢复多个文件

### Q5：中文文件名支持吗？

**完全支持**：
- ✅ 所有上传方式都支持中文文件名
- ✅ 断点续传也支持中文
- ✅ 文件名示例：`项目文档-2024年度.pdf`

---

## 📊 性能参考

**测试环境**：100Mbps 网络

| 文件大小 | 直接上传 | 分片上传 | 断点续传 |
|---------|---------|---------|---------|
| 10MB | 1秒 | 2秒 | 3秒（含哈希） |
| 100MB | 10秒 | 15秒 | 18秒（含哈希） |
| 1GB | 1分40秒 | 2分30秒 | 3分（含哈希） |
| 10GB | 16分40秒 | 25分 | 30分（含哈希） |

**注**：
- 哈希计算时间与文件大小成正比
- 实际速度受网络环境影响
- 断点续传第二次上传不需要重新计算哈希（如果文件未变）

---

## 🎓 最佳实践

1. **根据文件大小选择**
   - < 100MB → 直接上传
   - 100MB - 1GB → 分片上传
   - > 1GB → 断点续传

2. **网络不稳定时**
   - 始终使用断点续传
   - 即使小文件也推荐

3. **批量上传**
   - 混合大小文件时，先上传小文件
   - 大文件单独上传，使用断点续传

4. **企业环境**
   - 内网：直接上传或分片上传
   - VPN/远程：断点续传

5. **移动设备**
   - 4G/5G：建议使用断点续传
   - WiFi：根据文件大小选择

---

## 🔧 故障排除

### 上传卡在"正在计算文件哈希..."

**原因**：文件很大，哈希计算需要时间

**解决**：
- 耐心等待
- 10GB 文件约需 30-60 秒
- 不要刷新页面

### 分片上传失败

**检查**：
1. 服务器磁盘空间是否充足
2. 临时目录是否有写入权限
3. 网络是否稳定

**解决**：
- 刷新页面重试
- 使用断点续传代替

### 断点续传找不到之前的进度

**可能原因**：
1. 临时文件被清理
2. 文件内容被修改
3. 服务器重启且临时目录被清空

**解决**：
- 重新上传
- 保护临时文件不被清理

---

## 📞 获取帮助

遇到问题？查看：
- [README.md](README.md) - 完整文档
- [CHANGELOG.md](CHANGELOG.md) - 更新日志
- [GitHub Issues](https://github.com/your-repo/issues) - 报告问题

